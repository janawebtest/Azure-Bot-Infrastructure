parameters:
  - name: vmName
    type: string
    default: 'TestBotVM'
  - name: vmSize
    type: string
    default: 'Standard_B1s'

trigger: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  # The name of your Service Connection created in Project Settings
  serviceConnection: 'azurebotconnection' 

steps:
- task: TerraformInstaller@1
  inputs:
    terraformVersion: 'latest'

- task: TerraformTaskV4@4
  displayName: 'Terraform Init'
  inputs:
    provider: 'azurerm'
    command: 'init'
    workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
    backendServiceArm: '$(serviceConnection)'
    backendAzureRmResourceGroupName: 'your-storage-rg'
    backendAzureRmStorageAccountName: 'yourstorageaccountname'
    backendAzureRmContainerName: 'tfstate'
    backendAzureRmKey: 'terraform.tfstate'

- task: TerraformTaskV4@4
  displayName: 'Terraform Apply'
  inputs:
    provider: 'azurerm'
    command: 'apply'
    workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
    environmentServiceNameAzureRM: '$(serviceConnection)'
    commandOptions: '-var="vm_name=${{ parameters.vmName }}" -var="vm_size=${{ parameters.vmSize }}" -auto-approve'